<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validar Descuento QR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h2 {
      font-size: 1.5rem;
      text-align: center;
    }

    p, label, input, button {
      font-size: 1rem;
    }

    label {
      display: block;
      margin-top: 20px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      width: 100%;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    #resultado {
      margin-top: 20px;
      text-align: center;
    }

    code {
      background-color: #f4f4f4;
      padding: 2px 6px;
      border-radius: 4px;
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 1.3rem;
      }

      button {
        font-size: 0.95rem;
        padding: 10px;
      }

      input {
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <h2>Validaci√≥n de C√≥digo de Descuento</h2>
  <p id="codigoView">üìÑ C√≥digo le√≠do: <code></code></p>
  <p id="comercioInvitadoView">üè™ Comercio: <code></code></p>
  <p id="fechaMaximaView">üìÖ V√°lido hasta: <code></code></p>

  <label for="codigoSeguridad">Ingrese c√≥digo de seguridad:</label>
  <input type="text" id="codigoSeguridad" placeholder="Ej: 123456" required />

  <button id="validarBtn">‚úÖ Validar</button>
  <div id="resultado"></div>

  <script>
    const queryParams = new URLSearchParams(window.location.search);
    const codigo = queryParams.get("codigo");
    const comercioInvitado = queryParams.get("comercio_codigo");
    const fechaMaximaParam = queryParams.get("fecha_maxima");
    const scriptBaseURL = "https://script.google.com/macros/s/AKfycbyoyrxSAOZIJKGfc9wx1CIhlUmS7ah_n4hDKNTLsOii_Jq-N17Oeno8IAclWRi-45iJ/exec";

    if (codigo) {
      document.querySelector("#codigoView code").textContent = codigo;
    }

    if (comercioInvitado) {
      document.querySelector("#comercioInvitadoView code").textContent = decodeURIComponent(comercioInvitado);
    }

    if (fechaMaximaParam) {
      const fecha = new Date(fechaMaximaParam);
      document.querySelector("#fechaMaximaView code").textContent = fecha.toLocaleDateString();
    }

    document.getElementById("validarBtn").addEventListener("click", () => {
      const codigoSeguridad = document.getElementById("codigoSeguridad").value.trim();
      if (!codigo || !comercioInvitado || !codigoSeguridad) {
        alert("Falta c√≥digo o c√≥digo de seguridad.");
        return;
      }

      const url = `${scriptBaseURL}?codigo=${encodeURIComponent(codigo)}&comercio_codigo=${encodeURIComponent(comercioInvitado)}&codigo_seguridad=${encodeURIComponent(codigoSeguridad)}&accion=validar`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const div = document.getElementById("resultado");
          if (!data.success) {
            const mensajeError = data.error || "C√≥digo inv√°lido o comercio no autorizado.";
            div.innerHTML = `<h3 style='color:red;'>${mensajeError}</h3>`;
            return;
          }

          const fechaMax = parsearFechaDMY(data.fecha_maxima);
          const hoy = new Date();

          if (data.estado === "Canjeado") {
            div.innerHTML = "<h3 style='color:red;'>Este c√≥digo ya fue canjeado.</h3>";
            return;
          }

          if (hoy > fechaMax) {
            div.innerHTML = `<h3 style='color:red;'>Este c√≥digo ha vencido (fecha l√≠mite: ${fechaMax.toLocaleDateString()})</h3>`;
            return;
          }

          // Mostrar descuento y bot√≥n de canje
          let descuento = data.descuento;
          if (typeof descuento === "number") {
            descuento = (descuento * 100).toFixed(0) + "%";
          }

          div.innerHTML = `<h3>Descuento: ${descuento}</h3>
            <p>V√°lido hasta: <strong>${fechaMax.toLocaleDateString()}</strong></p>
            <button onclick="canjear('${codigo}', '${comercioInvitado}', '${codigoSeguridad}')">üéüÔ∏è Canjear ahora</button>`;
        })
        .catch(() => {
          document.getElementById("resultado").innerHTML = "<h3 style='color:red;'>Error al validar el c√≥digo.</h3>";
        });
    });
    
    function parsearFechaDMY(fechaStr) {
      const partes = fechaStr.split("/");
      if (partes.length !== 3) return null;
      const [dia, mes, anio] = partes;
      return new Date(`${anio}-${mes}-${dia}`);
    }
    
    function canjear(codigo, comercioInvitado, codigoSeguridad) {
      const url = `${scriptBaseURL}?codigo=${encodeURIComponent(codigo)}&comercio_codigo=${encodeURIComponent(comercioInvitado)}&codigo_seguridad=${encodeURIComponent(codigoSeguridad)}&accion=canjear`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.estado === "CanjeadoAhora") {
            document.getElementById("resultado").innerHTML = "<h3 style='color:green;'>¬°Descuento canjeado exitosamente!</h3>";
          } else {
            const msg = data.error || "No se pudo canjear el descuento.";
            document.getElementById("resultado").innerHTML = `<h3 style='color:red;'>${msg}</h3>`;
          }
        })
        .catch(() => {
          document.getElementById("resultado").innerHTML = "<h3 style='color:red;'>Error al canjear el c√≥digo.</h3>";
        });
    }
  </script>
</body>
</html>
